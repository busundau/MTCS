import serial
import serial.tools.list_ports
import tkinter as tk
from tkinter import ttk, scrolledtext
import threading
import time
from datetime import datetime

class SerialGUI:
    def __init__(self, root):
        self.root = root
        root.title("Serial Hex Sender")

        # COM port 下拉選單
        self.ports = [p.device for p in serial.tools.list_ports.comports()]
        self.port_var = tk.StringVar(value=self.ports[0] if self.ports else "")
        ttk.Label(root, text="Port:").grid(row=0, column=0, padx=5, pady=5)
        ttk.OptionMenu(root, self.port_var, self.port_var.get(), *self.ports).grid(row=0, column=1)

        # Baudrate 下拉選單
        self.baud_var = tk.StringVar(value="115200")
        ttk.Label(root, text="Baudrate:").grid(row=1, column=0, padx=5, pady=5)
        ttk.Combobox(root, textvariable=self.baud_var,
                     values=["9600","19200","38440","57600","115200"], width=10).grid(row=1, column=1)

        # 啟動 / 停止 按鈕
        self.toggle_btn = ttk.Button(root, text="Start", command=self.toggle_loop)
        self.toggle_btn.grid(row=0, column=2, rowspan=2, padx=5)

        # Log 顯示區
        self.log = scrolledtext.ScrolledText(root, width=80, height=20)
        self.log.grid(row=2, column=0, columnspan=3, padx=5, pady=5)

        self.ser = None
        self.running = False
        self.thread = None
        self.delay = 0.1

        # hex 指令清單（與原本內容一致）
        self.hex_cmds = [
            #01
    
    "3B 2C 2F 00 00 01 04 05 1E 00 48 01 01 02 01 02 05 05 01 C0 12 00 00 00 00 00 00 00 00 20 20 20 20 20 45 32 35 2D 4D 41 4C 4F 50 20 20 20 20 20 20 35 ",

 
    
    "3B 2C 2F 00 00 01 04 05 1E 00 48 01 01 02 01 02 05 05 01 C0 12 00 00 00 00 00 00 00 00 20 20 20 20 20 45 32 35 2D 4D 41 4C 4F 50 20 20 20 20 20 20 35 ",

 
    
    "3B 2C 2F 00 00 01 04 05 1E 00 48 01 01 02 01 02 05 05 01 C0 12 00 00 00 00 00 00 00 00 20 20 20 20 20 45 32 35 2D 4D 41 4C 4F 50 20 20 20 20 20 20 35 ",

 
    
    "3B 2C 2F 00 00 01 04 05 1E 00 48 01 01 02 01 02 05 05 01 C0 12 00 00 00 00 00 00 00 00 20 20 20 20 20 45 32 35 2D 4D 41 4C 4F 50 20 20 20 20 20 20 35 ",

 
    
    "3B 2C 2F 00 00 01 04 05 1E 00 48 01 01 02 01 02 05 05 01 C0 12 00 00 00 00 00 00 00 00 20 20 20 20 20 45 32 35 2D 4D 41 4C 4F 50 20 20 20 20 20 20 35 ",

 
    
    #02
    
    "3B 2C 2F 00 00 01 04 05 1E 00 49 01 01 02 01 02 05 05 01 C0 12 00 00 00 00 00 00 00 00 20 20 20 20 20 45 32 35 2D 4D 41 4C 4F 50 20 20 20 20 20 20 36 ",

 
    
    "3B 2C 2F 00 00 01 04 05 1E 00 49 01 01 02 01 02 05 05 01 C0 12 00 00 00 00 00 00 00 00 20 20 20 20 20 45 32 35 2D 4D 41 4C 4F 50 20 20 20 20 20 20 36 ",

 
    
    "3B 2C 2F 00 00 01 04 05 1E 00 49 01 01 02 01 02 05 05 01 C0 12 00 00 00 00 00 00 00 00 20 20 20 20 20 45 32 35 2D 4D 41 4C 4F 50 20 20 20 20 20 20 36 ",

 
    
    "3B 2C 2F 00 00 01 04 05 1E 00 49 01 01 02 01 02 05 05 01 C0 12 00 00 00 00 00 00 00 00 20 20 20 20 20 45 32 35 2D 4D 41 4C 4F 50 20 20 20 20 20 20 36 ",

 
    
    "3B 2C 2F 00 00 01 04 05 1E 00 49 01 01 02 01 02 05 05 01 C0 12 00 00 00 00 00 00 00 00 20 20 20 20 20 45 32 35 2D 4D 41 4C 4F 50 20 20 20 20 20 20 36 ",

 
    
    #03
    "3B 2C 09 0A 01 02 03 06 03 00 00 22 ",

 
    
    "3B 2C 09 0A 01 02 03 06 03 00 00 22 ",

 
    
    "3B 2C 09 0A 01 02 03 06 03 00 00 22 ",

 
    
    "3B 2C 09 0A 01 02 03 06 03 00 00 22 ",

 
    
    "3B 2C 09 0A 01 02 03 06 03 00 00 22 ",

 
    
    #04
    "3B 2C 09 0B 01 08 07 05 01 00 00 2A ",

 
    
    "3B 2C 09 0B 01 08 07 05 01 00 00 2A ",

 
    
    "3B 2C 09 0B 01 08 07 05 01 00 00 2A ",

 
    
    "3B 2C 09 0B 01 08 07 05 01 00 00 2A ",

 
    
    "3B 2C 09 0B 01 08 07 05 01 00 00 2A ",

 
    
    #05
    "3B 2C 09 0B 01 08 07 05 03 01 00 2D ",

 
    
    "3B 2C 09 0B 01 08 07 05 03 01 00 2D ",

 
    
    "3B 2C 09 0B 01 08 07 05 03 01 00 2D ",

 
    
    "3B 2C 09 0B 01 08 07 05 03 01 00 2D ",

 
    
    "3B 2C 09 0B 01 08 07 05 03 01 00 2D ",

 
    
    #06
    "3B 2C 09 0B 01 08 07 05 03 00 01 2D ",

 
    
    "3B 2C 09 0B 01 08 07 05 03 00 01 2D ",

 
    
    "3B 2C 09 0B 01 08 07 05 03 00 01 2D ",

 
    
    "3B 2C 09 0B 01 08 07 05 03 00 01 2D ",

 
    
    "3B 2C 09 0B 01 08 07 05 03 00 01 2D ",

 
    
    #07
    
    "3B 2C 09 0B 01 08 07 05 01 00 00 2A ",

 
    
    "3B 2C 09 0B 01 08 07 05 01 00 00 2A ",

 
    
    "3B 2C 09 0B 01 08 07 05 01 00 00 2A ",

 
    
    "3B 2C 09 0B 01 08 07 05 01 00 00 2A ",

 
    
    "3B 2C 09 0B 01 08 07 05 01 00 00 2A ",

 
    
    #08
    
    "3B 2C 09 0A 01 02 03 06 03 00 00 22 ",

 
    
    "3B 2C 09 0A 01 02 03 06 03 00 00 22 ",

 
    
    "3B 2C 09 0A 01 02 03 06 03 00 00 22 ",

 
    
    "3B 2C 09 0A 01 02 03 06 03 00 00 22 ",

 
    
    "3B 2C 09 0A 01 02 03 06 03 00 00 22 ",

 
    #09
    "3B 2C 0B 14 01 02 03 00 03 00 09 09 09 43 ",

 
    
    "3B 2C 0B 14 01 02 03 00 03 00 09 09 09 43 ",

 
    
    "3B 2C 0B 14 01 02 03 00 03 00 09 09 09 43 ",

 
    
    "3B 2C 0B 14 01 02 03 00 03 00 09 09 09 43 ",

 
    
    "3B 2C 0B 14 01 02 03 00 03 00 09 09 09 43 ",

 
    #10
    "3B 2C 08 1E 01 02 03 06 13 00 45",

 
    
    "3B 2C 08 1E 01 02 03 06 13 00 45",

 
    
    "3B 2C 08 1E 01 02 03 06 13 00 45",

 
    
    "3B 2C 08 1E 01 02 03 06 13 00 45",

 
    
    "3B 2C 08 1E 01 02 03 06 13 00 45",

 
    #11
    
    "3B 2C 08 1F 01 08 07 05 13 11 60",

 
    
    "3B 2C 08 1F 01 08 07 05 13 11 60",

 
    
    "3B 2C 08 1F 01 08 07 05 13 11 60",

 
    
    "3B 2C 08 1F 01 08 07 05 13 11 60",

 
    
    "3B 2C 08 1F 01 08 07 05 13 11 60",

 
    #12
    
    "3B 2C 08 1F 01 08 07 05 13 21 70 ",

    #read_serial("3B 2C 08 1F 01 08 07 05 13 31 80 ",
    
    "3B 2C 08 1F 01 08 07 05 13 21 70 ",

    #read_serial("3B 2C 08 1F 01 08 07 05 13 31 80 ",
    
    "3B 2C 08 1F 01 08 07 05 13 21 70 ",

    #read_serial("3B 2C 08 1F 01 08 07 05 13 31 80 ",
    
    "3B 2C 08 1F 01 08 07 05 13 21 70 ",

 
    
    "3B 2C 08 1F 01 08 07 05 13 21 70 ",

 
    #13-a
    
    "3B 2C 08 1F 01 08 07 05 13 31 80 ",

 
    
    "3B 2C 08 1F 01 08 07 05 13 31 80 ",

 
    
    "3B 2C 08 1F 01 08 07 05 13 31 80 ",

 
    
    "3B 2C 08 1F 01 08 07 05 13 31 80 ",

 
    
    "3B 2C 08 1F 01 08 07 05 13 31 80 ",

 
    
    #13
    
    "3B 2C 08 1F 01 08 07 05 13 41 90 ",

 
    
    "3B 2C 08 1F 01 08 07 05 13 41 90 ",

 
    
    "3B 2C 08 1F 01 08 07 05 13 41 90 ",

 
    
    "3B 2C 08 1F 01 08 07 05 13 41 90 ",

 
    
    "3B 2C 08 1F 01 08 07 05 13 41 90 ",

 
    #14
    
    "3B 2C 08 1F 01 08 07 05 13 51 A0",

 
    
    "3B 2C 08 1F 01 08 07 05 13 51 A0",

 
    
    "3B 2C 08 1F 01 08 07 05 13 51 A0",

 
    
    "3B 2C 08 1F 01 08 07 05 13 51 A0",

 
    
    "3B 2C 08 1F 01 08 07 05 13 51 A0",

 
    #15
    
    "3B 2C 08 1F 01 08 07 05 13 61 B0 ",

 
    
    "3B 2C 08 1F 01 08 07 05 13 61 B0 ",

 
    
    "3B 2C 08 1F 01 08 07 05 13 61 B0 ",

 
    
    "3B 2C 08 1F 01 08 07 05 13 61 B0 ",

 
    
    "3B 2C 08 1F 01 08 07 05 13 61 B0 ",

 
    #16
    
    "3B 2C 08 1F 01 08 07 05 13 11 60 ",

 
    
    "3B 2C 08 1F 01 08 07 05 13 11 60 ",

 
    
    "3B 2C 08 1F 01 08 07 05 13 11 60 ",

 
    
    "3B 2C 08 1F 01 08 07 05 13 11 60 ",

 
    
    "3B 2C 08 1F 01 08 07 05 13 11 60 ",

 
    #17
    
    "3B 2C 08 1E 01 02 03 06 13 00 45 ",

 
    
    "3B 2C 08 1E 01 02 03 06 13 00 45 ",

 
    
    "3B 2C 08 1E 01 02 03 06 13 00 45 ",

 
    
    "3B 2C 08 1E 01 02 03 06 13 00 45 ",

 
    
    "3B 2C 08 1E 01 02 03 06 13 00 45 ",

 
    #18
    
    "3B 2C 0B 14 01 02 03 00 03 00 09 09 09 43",

 
    
    "3B 2C 0B 14 01 02 03 00 03 00 09 09 09 43",

 
    
    "3B 2C 0B 14 01 02 03 00 03 00 09 09 09 43",

 
    
    "3B 2C 0B 14 01 02 03 00 03 00 09 09 09 43",

 
    
    "3B 2C 0B 14 01 02 03 00 03 00 09 09 09 43",

 
    #19
    
    "3B 2C 08 1E 01 02 03 06 13 00 45",

 
    
    "3B 2C 08 1E 01 02 03 06 13 00 45",

 
    
    "3B 2C 08 1E 01 02 03 06 13 00 45",

 
    
    "3B 2C 08 1E 01 02 03 06 13 00 45",

 
    
    "3B 2C 08 1E 01 02 03 06 13 00 45",

 
    #20
    
    "3B 2C 2B 29 01 01 08 0B 06 4A 31 2D 53 45 51 2D 31 00 00 00 00 31 32 4E 6D 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 05 00 01 00 82",

 
    
    "3B 2C 2B 29 01 01 08 0B 06 4A 31 2D 53 45 51 2D 31 00 00 00 00 31 32 4E 6D 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 05 00 01 00 82",

 
    
    "3B 2C 2B 29 01 01 08 0B 06 4A 31 2D 53 45 51 2D 31 00 00 00 00 31 32 4E 6D 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 05 00 01 00 82",

 
    
    "3B 2C 2B 29 01 01 08 0B 06 4A 31 2D 53 45 51 2D 31 00 00 00 00 31 32 4E 6D 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 05 00 01 00 82",

 
    
    "3B 2C 2B 29 01 01 08 0B 06 4A 31 2D 53 45 51 2D 31 00 00 00 00 31 32 4E 6D 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 05 00 01 00 82",

 
    #21
    
    "3B 2C 19 2A 01 01 01 08 0A 09 01 09 01 01 08 07 00 00 00 FA 00 E8 03 00 00 00 00 61 ",

 
    
    "3B 2C 19 2A 01 01 01 08 0A 09 01 09 01 01 08 07 00 00 00 FA 00 E8 03 00 00 00 00 61 ",

 
    
    "3B 2C 19 2A 01 01 01 08 0A 09 01 09 01 01 08 07 00 00 00 FA 00 E8 03 00 00 00 00 61 ",

 
    
    "3B 2C 19 2A 01 01 01 08 0A 09 01 09 01 01 08 07 00 00 00 FA 00 E8 03 00 00 00 00 61 ",

 
    
    "3B 2C 19 2A 01 01 01 08 0A 09 01 09 01 01 08 07 00 00 00 FA 00 E8 03 00 00 00 00 61 ",

 
    
    #22
    
    "3B 2C 21 2B 01 01 01 08 0A 09 01 A0 03 02 00 00 00 00 00 88 77 00 00 01 D0 02 00 00 00 88 13 00 00 3C 00 B9",

 
    
    "3B 2C 21 2B 01 01 01 08 0A 09 01 A0 03 02 00 00 00 00 00 88 77 00 00 01 D0 02 00 00 00 88 13 00 00 3C 00 B9",

 
    
    "3B 2C 21 2B 01 01 01 08 0A 09 01 A0 03 02 00 00 00 00 00 88 77 00 00 01 D0 02 00 00 00 88 13 00 00 3C 00 B9",

 
    
    "3B 2C 21 2B 01 01 01 08 0A 09 01 A0 03 02 00 00 00 00 00 88 77 00 00 01 D0 02 00 00 00 88 13 00 00 3C 00 B9",

 
    
    "3B 2C 21 2B 01 01 01 08 0A 09 01 A0 03 02 00 00 00 00 00 88 77 00 00 01 D0 02 00 00 00 88 13 00 00 3C 00 B9",

 
    #23
    
    "3B 2C 19 2A 01 01 01 08 0A 09 01 09 01 01 08 07 00 00 00 FA 00 E8 03 00 00 00 00 61",

 
    
    "3B 2C 19 2A 01 01 01 08 0A 09 01 09 01 01 08 07 00 00 00 FA 00 E8 03 00 00 00 00 61",

 
    
    "3B 2C 19 2A 01 01 01 08 0A 09 01 09 01 01 08 07 00 00 00 FA 00 E8 03 00 00 00 00 61",

 
    
    "3B 2C 19 2A 01 01 01 08 0A 09 01 09 01 01 08 07 00 00 00 FA 00 E8 03 00 00 00 00 61",

 
    
    "3B 2C 19 2A 01 01 01 08 0A 09 01 09 01 01 08 07 00 00 00 FA 00 E8 03 00 00 00 00 61",

 
    #24
    
    "3B 2C 19 2A 01 01 02 08 0A 09 02 01 01 02 10 27 00 00 00 64 00 D0 07 00 00 00 00 DA ",

 
    
    "3B 2C 19 2A 01 01 02 08 0A 09 02 01 01 02 10 27 00 00 00 64 00 D0 07 00 00 00 00 DA ",

 
    
    "3B 2C 19 2A 01 01 02 08 0A 09 02 01 01 02 10 27 00 00 00 64 00 D0 07 00 00 00 00 DA ",

 
    
    "3B 2C 19 2A 01 01 02 08 0A 09 02 01 01 02 10 27 00 00 00 64 00 D0 07 00 00 00 00 DA ",

 
    
    "3B 2C 19 2A 01 01 02 08 0A 09 02 01 01 02 10 27 00 00 00 64 00 D0 07 00 00 00 00 DA ",

 
    
    #25
    
    "3B 2C 21 2B 01 01 02 08 0A 09 01 A0 03 02 00 00 00 00 00 88 77 00 00 02 88 13 00 00 02 88 13 00 00 3C 00 86 ",

 
    
    "3B 2C 21 2B 01 01 02 08 0A 09 01 A0 03 02 00 00 00 00 00 88 77 00 00 02 88 13 00 00 02 88 13 00 00 3C 00 86 ",

 
    
    "3B 2C 21 2B 01 01 02 08 0A 09 01 A0 03 02 00 00 00 00 00 88 77 00 00 02 88 13 00 00 02 88 13 00 00 3C 00 86 ",

 
    
    "3B 2C 21 2B 01 01 02 08 0A 09 01 A0 03 02 00 00 00 00 00 88 77 00 00 02 88 13 00 00 02 88 13 00 00 3C 00 86 ",

 
    
    "3B 2C 21 2B 01 01 02 08 0A 09 01 A0 03 02 00 00 00 00 00 88 77 00 00 02 88 13 00 00 02 88 13 00 00 3C 00 86 ",

 
    #26
    
    "3B 2C 2B 29 01 02 08 0B 06 4A 31 2D 53 45 51 2D 32 00 00 00 00 31 32 4E 6D 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 01 00 01 83 ",

 
    
    "3B 2C 2B 29 01 02 08 0B 06 4A 31 2D 53 45 51 2D 32 00 00 00 00 31 32 4E 6D 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 01 00 01 83 ",

 
    
    "3B 2C 2B 29 01 02 08 0B 06 4A 31 2D 53 45 51 2D 32 00 00 00 00 31 32 4E 6D 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 01 00 01 83 ",

 
    
    "3B 2C 2B 29 01 02 08 0B 06 4A 31 2D 53 45 51 2D 32 00 00 00 00 31 32 4E 6D 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 01 00 01 83 ",

 
    
    "3B 2C 2B 29 01 02 08 0B 06 4A 31 2D 53 45 51 2D 32 00 00 00 00 31 32 4E 6D 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 01 00 01 83 ",

 
    #27
    
    "3B 2C 14 28 01 02 03 06 4A 4F 42 2D 31 00 00 00 00 00 00 00 01 00 82 ",

 
    
    "3B 2C 14 28 01 02 03 06 4A 4F 42 2D 31 00 00 00 00 00 00 00 01 00 82 ",

 
    
    "3B 2C 14 28 01 02 03 06 4A 4F 42 2D 31 00 00 00 00 00 00 00 01 00 82 ",

 
    
    "3B 2C 14 28 01 02 03 06 4A 4F 42 2D 31 00 00 00 00 00 00 00 01 00 82 ",

 
    
    "3B 2C 14 28 01 02 03 06 4A 4F 42 2D 31 00 00 00 00 00 00 00 01 00 82 ",

 
    
    "3B 2C 14 28 01 02 03 06 4A 4F 42 2D 31 00 00 00 00 00 00 00 01 00 82 ",

 
    
    #27-a
    
    "3B 2C 36 32 01 02 03 00 01 00 53 4E 30 30 31 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 4D 54 43 53 35 31 32 00 00 00 00 00 00 00 00 00 00 00 00 00 18 17 7A 09 00 00 22",

 
    #28
    
    
    "3B 2C 1F 3C 01 02 03 00 04 C0 A8 01 3E C0 A8 01 01 FF FF FF 00 78 72 64 70 00 56 C0 A8 01 CD 88 13 58",

 
    
    
    "3B 2C 1F 3C 01 02 03 00 04 C0 A8 01 3E C0 A8 01 01 FF FF FF 00 78 72 64 70 00 56 C0 A8 01 CD 88 13 58",

 
    
    
    "3B 2C 1F 3C 01 02 03 00 04 C0 A8 01 3E C0 A8 01 01 FF FF FF 00 78 72 64 70 00 56 C0 A8 01 CD 88 13 58",

 
    
    
    "3B 2C 1F 3C 01 02 03 00 04 C0 A8 01 3E C0 A8 01 01 FF FF FF 00 78 72 64 70 00 56 C0 A8 01 CD 88 13 58",

 
    
    
    "3B 2C 1F 3C 01 02 03 00 04 C0 A8 01 3E C0 A8 01 01 FF FF FF 00 78 72 64 70 00 56 C0 A8 01 CD 88 13 58",

 
    #29
    
    "3B 2C 26 46 01 02 03 00 43 4D 53 2D 57 69 46 69 5F 30 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B2 ",

 
    #29
    
    "3B 2C 26 46 01 02 03 00 43 4D 53 2D 57 69 46 69 5F 30 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B2 ",

 
    #29
    
    "3B 2C 26 46 01 02 03 00 43 4D 53 2D 57 69 46 69 5F 30 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B2 ",

 
    #29
    
    "3B 2C 26 46 01 02 03 00 43 4D 53 2D 57 69 46 69 5F 30 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B2 ",

 
    #29
    
    "3B 2C 26 46 01 02 03 00 43 4D 53 2D 57 69 46 69 5F 30 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B2 ",

 
    #30
    
    "3B 2C 2F 00 00 01 04 05 0E 00 49 01 01 02 01 02 05 05 01 C0 12 00 00 00 00 00 00 00 00 20 20 20 20 20 20 20 20 52 45 41 44 59 20 20 20 20 20 20 20 C9 ",

 
    
    "3B 2C 2F 00 00 01 04 05 0E 00 49 01 01 02 01 02 05 05 01 C0 12 00 00 00 00 00 00 00 00 20 20 20 20 20 20 20 20 52 45 41 44 59 20 20 20 20 20 20 20 C9 ",

 
    
    "3B 2C 2F 00 00 01 04 05 0E 00 49 01 01 02 01 02 05 05 01 C0 12 00 00 00 00 00 00 00 00 20 20 20 20 20 20 20 20 52 45 41 44 59 20 20 20 20 20 20 20 C9 ",

 
    
    "3B 2C 2F 00 00 01 04 05 0E 00 49 01 01 02 01 02 05 05 01 C0 12 00 00 00 00 00 00 00 00 20 20 20 20 20 20 20 20 52 45 41 44 59 20 20 20 20 20 20 20 C9 ",

 
    
    "3B 2C 2F 00 00 01 04 05 0E 00 49 01 01 02 01 02 05 05 01 C0 12 00 00 00 00 00 00 00 00 20 20 20 20 20 20 20 20 52 45 41 44 59 20 20 20 20 20 20 20 C9 "
        ]

    def start_serial(self):
        try:
            self.ser = serial.Serial(self.port_var.get(),
                                     int(self.baud_var.get()),
                                     timeout=1)
            self.running = True
            self.thread = threading.Thread(target=self.send_loop, daemon=True)
            self.thread.start()
            self.toggle_btn.config(text="Stop")
            self.log.insert(tk.END, f"Opened {self.port_var.get()} @ {self.baud_var.get()}\n")
        except Exception as e:
            self.log.insert(tk.END, f"Error opening serial: {e}\n")

    def stop_serial(self):
        self.running = False
        if self.thread:
            self.thread.join(timeout=1)
        if self.ser and self.ser.is_open:
            self.ser.close()
            self.log.insert(tk.END, "Serial port closed.\n")
        self.toggle_btn.config(text="Start")

    def toggle_loop(self):
        if self.running:
            self.stop_serial()
        else:
            self.start_serial()

    def send_loop(self):
        start_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        with open("serial_log.txt", "a", encoding="utf-8") as logfile:
            header = f"=== Start Time: {start_time} ===\n"
            self.log.insert(tk.END, header)
            logfile.write(header)

            while self.running:
                for hex_str in self.hex_cmds:
                    if not self.running:
                        break
                    timestamp = datetime.now().strftime("[%Y-%m-%d %H:%M:%S]")
                    try:
                        data = bytes.fromhex(hex_str)
                        self.ser.write(data)
                        sent_msg = f"{timestamp} Sent: {hex_str}\n"
                        self.log.insert(tk.END, sent_msg)
                        logfile.write(sent_msg)

                        time.sleep(self.delay)

                        # 讀取所有可用的序列埠資料
                        if self.ser.in_waiting:
                            response = self.ser.read(self.ser.in_waiting)
                            ascii_text = ''.join(chr(b) if 32 <= b <= 126 else '.' for b in response)
                            recv_msg = f"{timestamp} Recv ASCII: {ascii_text}\n"
                            self.log.insert(tk.END, recv_msg)
                            logfile.write(recv_msg)

                    except Exception as e:
                        error_msg = f"{timestamp} Error Write/Read: {e}\n"
                        self.log.insert(tk.END, error_msg)
                        logfile.write(error_msg)
                        self.running = False
                        break

                    time.sleep(self.delay)

            end_msg = f"{datetime.now().strftime('[%Y-%m-%d %H:%M:%S]')} End of send loop.\n"
            self.log.insert(tk.END, end_msg)
            logfile.write(end_msg)

if __name__ == "__main__":
    root = tk.Tk()
    app = SerialGUI(root)
    root.mainloop()